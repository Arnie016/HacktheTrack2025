{% extends "base.html" %}

{% block title %}Live Demo - AI Pit Strategy{% endblock %}

{% block extra_css %}
<style>
    .demo-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
    }
    
    .slider-container {
        margin: 1.5rem 0;
    }
    
    .slider-label {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: #555;
    }
    
    .slider-value {
        color: var(--primary);
        font-weight: bold;
    }
    
    input[type="range"] {
        width: 100%;
        height: 8px;
        border-radius: 5px;
        background: #ddd;
        outline: none;
        -webkit-appearance: none;
    }
    
    input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--primary);
        cursor: pointer;
    }
    
    input[type="range"]::-moz-range-thumb {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--primary);
        cursor: pointer;
    }
    
    .checkbox-group label {
        display: flex;
        align-items: center;
        cursor: pointer;
        padding: 10px;
        border-radius: 8px;
        transition: background 0.2s;
    }
    
    .checkbox-group label:hover {
        background: #f5f5f5;
    }
    
    .checkbox-group input[type="checkbox"] {
        width: 20px;
        height: 20px;
        margin-right: 10px;
        cursor: pointer;
    }
    
    .btn {
        width: 100%;
        padding: 15px;
        border: none;
        border-radius: 8px;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        margin-top: 15px;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
    }
    
    .result-display {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        padding: 2rem;
        border-radius: 15px;
        margin-top: 1rem;
        display: none;
    }
    
    .result-display.show {
        display: block;
    }
    
    .result-lap {
        font-size: 4em;
        font-weight: bold;
        text-align: center;
        margin: 1rem 0;
    }
    
    .result-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.5rem;
        margin-top: 1.5rem;
    }
    
    .result-item {
        background: rgba(255,255,255,0.15);
        padding: 1rem;
        border-radius: 10px;
        backdrop-filter: blur(10px);
    }
    
    .result-item h4 {
        opacity: 0.9;
        margin-bottom: 0.5rem;
    }
    
    .result-item .value {
        font-size: 1.5em;
        font-weight: bold;
    }
    
    @media (max-width: 968px) {
        .demo-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>üéÆ Live Demo</h1>
    <p>Interactive AI pit strategy recommendations using <strong>REAL TRAINED MODELS</strong></p>
</div>

<div class="card" style="background: #e3f2fd; border-left: 5px solid #2196F3; padding: 1.5rem; margin-bottom: 2rem;">
    <h3 style="color: #1976D2; margin-bottom: 1rem;">üí° How This Works</h3>
    <p style="line-height: 1.8; color: #333; margin-bottom: 1rem;">
        When you click <strong>"Get AI Recommendation"</strong>, your browser sends your parameters to a <strong>local Python backend</strong> running on this machine (localhost:5002).
        The backend calls <code style="background: white; padding: 2px 6px; border-radius: 3px;">solve_pit_strategy_improved()</code> which:
    </p>
    <ul style="line-height: 2; color: #333; margin-left: 2rem;">
        <li>‚úÖ Loads the <strong>real XGBoost tire wear model</strong> (776 KB trained on 10,847 laps)</li>
        <li>‚úÖ Runs <strong>1,000 Monte Carlo simulations</strong> with variance reduction</li>
        <li>‚úÖ Applies <strong>damage detection</strong> (trained on Race 2 damage cases)</li>
        <li>‚úÖ Uses <strong>position-aware strategy</strong> (50% expert agreement, Grade B)</li>
        <li>‚úÖ Returns recommendation with <strong>confidence interval</strong> (¬±58-80s)</li>
    </ul>
    <p style="line-height: 1.8; color: #333; margin-top: 1rem;">
        <strong>This is NOT a mockup.</strong> It's the same optimizer validated on 59 real Race 2 pit decisions.
        The API endpoint is <code style="background: white; padding: 2px 6px; border-radius: 3px;">POST /api/get_recommendation</code> running locally.
    </p>
</div>

<div class="card" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 1.5rem;">
    <h3 style="color: white; border: none; margin-bottom: 1rem;">ü§ñ Model Status (Real-Time)</h3>
    <div id="modelStatus" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
        <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: 8px; text-align: center;">
            <strong>Wear Model</strong><br>
            <span id="wearStatus">Loading...</span>
        </div>
        <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: 8px; text-align: center;">
            <strong>Damage Detector</strong><br>
            <span id="damageStatus">Loading...</span>
        </div>
        <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: 8px; text-align: center;">
            <strong>Position Optimizer</strong><br>
            <span id="positionStatus">Loading...</span>
        </div>
    </div>
</div>

<div class="demo-grid">
    <div class="card">
        <h2>üìä Race Parameters</h2>
        
        <div class="slider-container">
            <div class="slider-label">
                <span>Current Lap</span>
                <span class="slider-value" id="currentLapValue">15</span>
            </div>
            <input type="range" id="currentLap" min="1" max="52" value="15" oninput="updateSlider('currentLap')">
        </div>
        
        <div class="slider-container">
            <div class="slider-label">
                <span>Tire Age (laps)</span>
                <span class="slider-value" id="tireAgeValue">10</span>
            </div>
            <input type="range" id="tireAge" min="1" max="30" value="10" oninput="updateSlider('tireAge')">
        </div>
        
        <div class="slider-container">
            <div class="slider-label">
                <span>Current Position</span>
                <span class="slider-value" id="currentPositionValue">P5</span>
            </div>
            <input type="range" id="currentPosition" min="1" max="20" value="5" oninput="updateSlider('currentPosition')">
        </div>
        
        <div class="slider-container">
            <div class="slider-label">
                <span>Gap to Car Ahead (s)</span>
                <span class="slider-value" id="gapAheadValue">2.5s</span>
            </div>
            <input type="range" id="gapAhead" min="0" max="10" step="0.5" value="2.5" oninput="updateSlider('gapAhead')">
        </div>
        
        <div class="slider-container">
            <div class="slider-label">
                <span>Gap to Car Behind (s)</span>
                <span class="slider-value" id="gapBehindValue">3.0s</span>
            </div>
            <input type="range" id="gapBehind" min="0" max="10" step="0.5" value="3.0" oninput="updateSlider('gapBehind')">
        </div>
        
        <h3 style="margin-top: 2rem; margin-bottom: 1rem; color: var(--primary);">‚ö†Ô∏è Damage Indicators</h3>
        
        <div class="checkbox-group">
            <label>
                <input type="checkbox" id="sectorDrop">
                <span>Sector 3 time drop (>2 std dev)</span>
            </label>
            <label>
                <input type="checkbox" id="speedLoss">
                <span>Top speed loss (>5 km/h)</span>
            </label>
        </div>
        
        <div style="margin-top: 1.5rem;">
            <label style="font-weight: 600; color: #555; display: block; margin-bottom: 0.5rem;">
                Recent Lap Times (last 5 laps, comma-separated):
            </label>
            <input type="text" id="lapTimes" placeholder="e.g. 91.2, 91.5, 92.1, 93.8, 94.2" 
                   value="91.2, 91.5, 92.1, 91.8, 92.0"
                   style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
        </div>
        
        <button class="btn btn-primary" onclick="getRecommendation()">
            üöÄ Get AI Recommendation
        </button>
    </div>
    
    <div class="card">
        <h2>üéØ AI Recommendation</h2>
        
        <div id="placeholder" style="text-align: center; padding: 3rem; color: #999;">
            <p style="font-size: 3em;">üèÅ</p>
            <p style="font-size: 1.2em;">Adjust parameters and click "Get AI Recommendation"</p>
        </div>
        
        <div class="result-display" id="results">
            <h3 style="text-align: center;">Recommended Pit Stop</h3>
            <div class="result-lap" id="recommendedLap">‚Äî</div>
            <p style="text-align: center; font-size: 1.1em;">
                Optimal Window: Lap <span id="windowStart">‚Äî</span> to <span id="windowEnd">‚Äî</span>
            </p>
            
            <div class="result-grid">
                <div class="result-item">
                    <h4>Strategy Type</h4>
                    <div class="value" id="strategyType">‚Äî</div>
                </div>
                
                <div class="result-item">
                    <h4>Confidence</h4>
                    <div class="value" id="confidenceValue">‚Äî</div>
                </div>
                
                <div class="result-item">
                    <h4>Expected Gain</h4>
                    <div class="value" id="expectedGain">‚Äî</div>
                </div>
                
                <div class="result-item">
                    <h4>Risk Level</h4>
                    <div class="value" id="riskLevel">‚Äî</div>
                </div>
            </div>
            
            <div style="background: rgba(255,255,255,0.15); padding: 1.5rem; border-radius: 10px; margin-top: 1.5rem;">
                <h4 style="margin-bottom: 0.75rem;">üí° AI Reasoning:</h4>
                <p id="reasoningText" style="line-height: 1.6;">‚Äî</p>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    function updateSlider(id) {
        const slider = document.getElementById(id);
        const display = document.getElementById(id + 'Value');
        let value = slider.value;
        
        if (id === 'currentPosition') {
            display.textContent = 'P' + value;
        } else if (id === 'gapAhead' || id === 'gapBehind') {
            display.textContent = value + 's';
        } else {
            display.textContent = value;
        }
    }
    
    async function getRecommendation() {
        const lapTimesStr = document.getElementById('lapTimes').value;
        const lapTimes = lapTimesStr.split(',').map(s => parseFloat(s.trim())).filter(n => !isNaN(n));
        
        const data = {
            current_lap: parseInt(document.getElementById('currentLap').value),
            total_laps: 52,
            tire_age: parseFloat(document.getElementById('tireAge').value),
            current_position: parseInt(document.getElementById('currentPosition').value),
            gap_ahead: parseFloat(document.getElementById('gapAhead').value),
            gap_behind: parseFloat(document.getElementById('gapBehind').value),
            recent_lap_times: lapTimes,
            sector_drop: document.getElementById('sectorDrop').checked,
            speed_loss: document.getElementById('speedLoss').checked,
        };
        
        try {
            const response = await fetch('/api/get_recommendation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            // Update model status
            if (result.model_status) {
                document.getElementById('wearStatus').textContent = result.model_status.wear_model + ' ‚úì';
                document.getElementById('damageStatus').textContent = result.model_status.damage_detector + ' ‚úì';
                document.getElementById('positionStatus').textContent = result.model_status.position_optimizer + ' ‚úì';
            }
            
            document.getElementById('placeholder').style.display = 'none';
            document.getElementById('recommendedLap').textContent = result.recommended_lap;
            document.getElementById('windowStart').textContent = result.window[0];
            document.getElementById('windowEnd').textContent = result.window[1];
            document.getElementById('strategyType').textContent = formatStrategyType(result.strategy_type);
            document.getElementById('confidenceValue').textContent = (result.confidence * 100).toFixed(1) + '%';
            document.getElementById('expectedGain').textContent = result.expected_gain;
            document.getElementById('riskLevel').textContent = result.risk_level;
            document.getElementById('reasoningText').textContent = result.reasoning;
            
            document.getElementById('results').classList.add('show');
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }
    
    function formatStrategyType(type) {
        const names = {
            'damage_pit': 'Damage Pit',
            'aggressive_undercut': 'Aggressive Undercut',
            'defensive_cover': 'Defensive Cover',
            'hold_position': 'Hold Position',
            'optimal_stint': 'Optimal Stint',
            'standard': 'Standard'
        };
        return names[type] || type;
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        updateSlider('currentLap');
        updateSlider('tireAge');
        updateSlider('currentPosition');
        updateSlider('gapAhead');
        updateSlider('gapBehind');
    });
</script>
{% endblock %}

